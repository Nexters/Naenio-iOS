# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Upload the app to Testflight"
  
  before_all do
    ENV["SLACK_URL"] = "https://hooks.slack.com/services/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"
  end
  
  lane :testFlight do
    # keychain ì´ˆê¸°í™” 
    create_keychain(
      name: ENV["KEYCHAIN_NAME"],
      password: ENV["KEYCHAIN_PASSWORD"],
      timeout: 1800,
      default_keychain: true,
      unlock: true,
      lock_when_sleeps: false
    )

    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
      )

    # matchë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸ì¦ì„œ ë° í”„ë¡œíŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° 
    match(
      git_url: "git@github.com:enebin/naenio-iOS-match.git",
      storage_mode: "git",
      type: "appstore",
      readonly: true,
      keychain_name: ENV["KEYCHAIN_NAME"],
      keychain_password: ENV["KEYCHAIN_PASSWORD"]
      )

    xcversion(version: "~> 13.0")

    cocoapods(
        clean: true,
        podfile: "./Podfile",
        try_repo_update_on_error: true,
        use_bundle_exec: false
    )

    # ë¹Œë“œ ë° ë‚´ë³´ë‚´ê¸° 
    gym(
      workspace: "Naenio.xcworkspace",
      scheme: "Testflight",
      configuration: "Release",
      export_options: {
        method: "app-store",
        signingStyle: "manual"
      }
    )	

    increment_build_number(
      xcodeproj: "Naenio.xcodeproj"
    )

    upload_to_testflight

  end
  
  # laneì´ ëª¨ë‘ ì™„ë£Œëœ ë’¤ í˜¸ì¶œë¨
  after_all do |lane|
    # 9. ë°°í¬ ê²°ê³¼ ìŠ¬ëž™ ë…¸í‹° ðŸš¨
    slack(
      message: "Testflightì— ìƒˆë¡œìš´ ë²„ì „ì´ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.",
      success: true,
      payload: {
        "Version" => lane_context[SharedValues::VERSION_NUMBER],
        "Build number" => lane_context[SharedValues::BUILD_NUMBER],
        "Date" => Time.new.to_s
      }
    )
  end

  # ì—ëŸ¬ ë°œìƒ ì‹œ í˜¸ì¶œ ë¨
  error do |lane, exception|
    slack(
      message: "ë¹Œë“œ ì‹¤íŒ¨",
      success: false,
      payload: {
        "Version" => lane_context[SharedValues::VERSION_NUMBER],
        "Build number" => lane_context[SharedValues::BUILD_NUMBER],
        "Date" => Time.new.to_s,
        "Error Info" => exception.message
        }
      )
  end
end
